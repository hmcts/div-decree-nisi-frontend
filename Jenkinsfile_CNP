#!groovy

@Library("Infrastructure")

String product = "div"
String component = "dn"

withPipeline("nodejs", product, component) {
  before('build') {
    sh 'https_proxy=http://proxyout.reform.hmcts.net:8080 curl -k https://idam.preprod.ccidam.reform.hmcts.net'
    sh 'curl -k https://idam.preprod.ccidam.reform.hmcts.net'
  }
  
  after('test') {
    sh 'yarn test:validation'
  }

  after('functionalTest:aat') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'smoke-output/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/**/*'
  }

  before('functionalTest:preview') {
    env.PREVIEW_ENV = 'true'
  }

  after('functionalTest:preview') {
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'smoke-output/**/*'
    steps.archiveArtifacts allowEmptyArchive: true, artifacts: 'functional-output/**/*'
  }

  enableSlackNotifications('#div-dev')
}
